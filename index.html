<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>宇宙乘法口訣表</title>
    <!-- 引入Tailwind CSS以進行樣式設計 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入中文字體以優化顯示 -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- 引入Tone.js庫來創建音效和音樂 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        /* 使用更適合中文的字體 */
        body {
            font-family: 'Inter', 'Noto Sans SC', sans-serif;
            /* 設定一個後備的深色背景，以防圖片載入失敗 */
            background-color: #0f172a;
            /* 背景圖片將由JavaScript動態設定 */
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            /* 為背景圖片的切換添加一個平滑的淡入效果 */
            transition: background-image 1s ease-in-out;
        }
        /* 為標題和段落添加文本陰影以提高在背景圖片上的可讀性 */
        h1, .container > p {
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.8);
        }
        
        /* 為按鈕添加簡單的點擊動畫效果 */
        .btn-speak, #check-answer-btn, #new-question-btn, #start-quiz-btn {
            transition: all 0.2s ease-in-out;
        }
        .btn-speak {
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .btn-speak:active {
            transform: scale(0.95) rotate(-2deg); /* 點擊時增加一個可愛的旋轉效果 */
        }
        .btn-speak:hover {
            box-shadow: 0 0 15px rgba(107, 114, 128, 0.5);
        }
        #check-answer-btn:active, #new-question-btn:active, #start-quiz-btn:active {
             transform: scale(0.95);
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div class="container mx-auto text-center">
        
        <!-- 測驗啟動按鈕 -->
        <div id="start-quiz-container" class="mb-10 p-6 rounded-2xl bg-slate-800/80 backdrop-blur-sm border border-slate-700 shadow-lg w-full max-w-md mx-auto">
            <h2 class="text-2xl font-bold text-cyan-300 mb-4">準備好了嗎？</h2>
            <button id="start-quiz-btn" class="w-full bg-emerald-500 hover:bg-emerald-400 text-white font-bold py-4 px-4 rounded-lg text-xl">開始挑戰！</button>
        </div>

        <!-- 測驗部分 (初始隱藏) -->
        <div id="quiz-section" class="hidden mb-10 p-6 rounded-2xl bg-slate-800/80 backdrop-blur-sm border border-slate-700 shadow-lg w-full max-w-md mx-auto">
            <h2 class="text-2xl font-bold text-cyan-300 mb-4">乘法挑戰</h2>
            <div id="quiz-question" class="text-4xl font-bold text-white mb-2 h-12"></div>
            <div id="quiz-mnemonic-hint" class="text-xl text-gray-300 mb-4 h-8"></div>
            <div class="flex items-center justify-center gap-4">
                <input type="number" id="quiz-answer" class="text-center text-2xl font-bold w-24 h-14 rounded-lg bg-slate-900 text-white border-2 border-slate-600 focus:border-cyan-400 focus:ring-0" placeholder="?">
                <button id="check-answer-btn" class="w-24 h-14 bg-emerald-500 hover:bg-emerald-400 text-white font-bold text-lg rounded-lg">確認</button>
            </div>
            <div id="quiz-feedback" class="mt-4 text-lg h-8"></div>
            <button id="new-question-btn" class="mt-4 w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-4 rounded-lg">下一題</button>
        </div>

        <h1 class="text-4xl font-bold mb-2 text-cyan-400 tracking-wider">宇宙乘法口訣表</h1>
        <p class="text-gray-300 mb-8">點擊下方的按鈕，探索乘法口訣的奧秘！</p>
        
        <!-- 乘法口訣表的容器 -->
        <div id="multiplication-table" class="grid grid-cols-4 sm:grid-cols-6 md:grid-cols-9 gap-3 md:gap-4 max-w-5xl mx-auto">
            <!-- 按鈕將由下方的JavaScript程式碼動態產生 -->
        </div>
    </div>

    <script>
        const tableContainer = document.getElementById('multiplication-table');

        // --- 每日必應壁紙 ---
        document.addEventListener('DOMContentLoaded', function() {
            // 使用一個可靠的API來獲取必應每日壁紙
            const bingApiUrl = 'https://bing.biturl.top/?resolution=1920&format=json&index=0&mkt=zh-CN';
            
            fetch(bingApiUrl)
                .then(response => response.json())
                .then(data => {
                    if (data.url) {
                        document.body.style.backgroundImage = `url(${data.url})`;
                    }
                })
                .catch(error => {
                    console.error("無法載入必應壁紙:", error);
                });
        });
        // --- 每日壁紙程式碼結束 ---

        // 定義中文乘法口訣的資料物件
        const mnemonics = {
            1: { 1: "一一得一", 2: "一二得二", 3: "一三得三", 4: "一四得四", 5: "一五得五", 6: "一六得六", 7: "一七得七", 8: "一八得八", 9: "一九得九" },
            2: { 2: "二二得四", 3: "二三得六", 4: "二四得八", 5: "二五一十", 6: "二六十二", 7: "二七十四", 8: "二八十六", 9: "二九十八" },
            3: { 3: "三三得九", 4: "三四十二", 5: "三五十五", 6: "三六十八", 7: "三七二十一", 8: "三八二十四", 9: "三九二十七" },
            4: { 4: "四四十六", 5: "四五二十", 6: "四六二十四", 7: "四七二十八", 8: "四八三十二", 9: "四九三十六" },
            5: { 5: "五五二十五", 6: "五六三十", 7: "五七三十五", 8: "五八四十", 9: "五九四十五" },
            6: { 6: "六六三十六", 7: "六七四十二", 8: "六八四十八", 9: "六九五十四" },
            7: { 7: "七七四十九", 8: "七八五十六", 9: "七九六十三" },
            8: { 8: "八八六十四", 9: "八九七十二" },
            9: { 9: "九九八十一" }
        };

        const spaceEmojis = ["☀️", "🚀", "🪐", "🌎", "🌟", "☄️", "🌕", "🌌", "👽"];
        const spaceColors = [
            'bg-indigo-600 hover:bg-indigo-500', 'bg-sky-600 hover:bg-sky-500',
            'bg-rose-600 hover:bg-rose-500', 'bg-emerald-600 hover:bg-emerald-500',
            'bg-purple-600 hover:bg-purple-500', 'bg-amber-600 hover:bg-amber-500',
            'bg-cyan-600 hover:bg-cyan-500', 'bg-violet-600 hover:bg-violet-500',
            'bg-fuchsia-600 hover:bg-fuchsia-500'
        ];

        let currentAudio = null;

        function speak(text, onEndCallback) {
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
            }
            const encodedText = encodeURIComponent(text);
            const apiUrl = `https://translate.google.com/translate_tts?ie=UTF-8&q=${encodedText}&tl=zh-CN&client=tw-ob`;
            currentAudio = new Audio(apiUrl);
            if (onEndCallback) {
                currentAudio.addEventListener('ended', onEndCallback, { once: true });
            }
            currentAudio.play().catch(e => console.error("音訊播放失敗:", e));
        }

        // --- 音效和音樂 ---
        let synth, backgroundMusic;
        let isAudioInitialized = false;

        function playCorrectSound() {
            if (!synth) return;
            synth.triggerAttackRelease("C5", "8n", Tone.now());
            synth.triggerAttackRelease("E5", "8n", Tone.now() + 0.1);
            synth.triggerAttackRelease("G5", "8n", Tone.now() + 0.2);
        }

        function playIncorrectSound() {
            if (!synth) return;
            synth.triggerAttackRelease("C3", "8n", Tone.now());
        }
        
        function playClickSound() {
            if (!synth) return;
            synth.triggerAttackRelease("C6", "16n");
        }
        
        function initializeAudio() {
            if(isAudioInitialized) return;
            isAudioInitialized = true;
            
            // 使用者互動後啟動Tone.js
            Tone.start();
             
            synth = new Tone.Synth({
                oscillator: { type: "sine" },
                envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 1 }
            }).toDestination();
            
            backgroundMusic = new Tone.Player({
                url: "https://storage.googleapis.com/magentadata/js/soundfonts/sgm_plus/0000_Sitar_0_84_11.mp3",
                loop: true,
                volume: -20,
                fadeIn: 2,
            }).toDestination();
        }
        // --- 音效程式碼結束 ---

        // --- 測驗部分程式碼 ---
        const startQuizContainer = document.getElementById('start-quiz-container');
        const startQuizBtn = document.getElementById('start-quiz-btn');
        const quizSection = document.getElementById('quiz-section');
        const quizQuestionEl = document.getElementById('quiz-question');
        const quizMnemonicHintEl = document.getElementById('quiz-mnemonic-hint');
        const quizAnswerEl = document.getElementById('quiz-answer');
        const checkAnswerBtn = document.getElementById('check-answer-btn');
        const newQuestionBtn = document.getElementById('new-question-btn');
        const quizFeedbackEl = document.getElementById('quiz-feedback');
        
        let currentNum1, currentNum2;

        function generateNewQuestion() {
            currentNum1 = Math.floor(Math.random() * 9) + 1;
            currentNum2 = Math.floor(Math.random() * 9) + 1;
            const smallerNum = Math.min(currentNum1, currentNum2);
            const largerNum = Math.max(currentNum1, currentNum2);
            const mnemonic = mnemonics[smallerNum][largerNum];
            let mnemonicQuestion;
            if (mnemonic.includes('得')) {
                const questionPartEnd = mnemonic.indexOf('得') + 1;
                mnemonicQuestion = mnemonic.substring(0, questionPartEnd) + '?';
            } else {
                mnemonicQuestion = mnemonic.slice(0, 2) + '?';
            }
            quizQuestionEl.textContent = `${currentNum1} × ${currentNum2} = ?`;
            quizMnemonicHintEl.textContent = `${mnemonicQuestion}？`;
            quizAnswerEl.value = '';
            quizAnswerEl.disabled = false;
            checkAnswerBtn.disabled = false;
            quizFeedbackEl.textContent = '';
            quizFeedbackEl.className = 'mt-4 text-lg h-8'; 
            speak(`${mnemonicQuestion}，請答題`);
        }

        function checkAnswer() {
            playClickSound();
            if (quizAnswerEl.disabled) return;
            const userAnswer = parseInt(quizAnswerEl.value, 10);
            const correctAnswer = currentNum1 * currentNum2;
            const smallerNum = Math.min(currentNum1, currentNum2);
            const largerNum = Math.max(currentNum1, currentNum2);
            const fullMnemonic = mnemonics[smallerNum][largerNum];

            if (userAnswer === correctAnswer) {
                playCorrectSound();
                quizFeedbackEl.textContent = '答對了！你真棒！🥳';
                quizFeedbackEl.className = 'mt-4 text-lg h-8 text-green-400 font-bold';
                quizAnswerEl.disabled = true;
                checkAnswerBtn.disabled = true;
                speak(fullMnemonic, () => speak("太棒了！"));
            } else {
                playIncorrectSound();
                quizFeedbackEl.textContent = '不對喔，再想一想！🤔';
                quizFeedbackEl.className = 'mt-4 text-lg h-8 text-amber-400 font-bold';
                speak("不對喔，再想一想");
                quizAnswerEl.value = '';
            }
        }
        
        startQuizBtn.addEventListener('click', () => {
            initializeAudio(); // 在第一次點擊時初始化所有音訊
            if(backgroundMusic && backgroundMusic.state !== "started") {
                backgroundMusic.start(); // **修復**：確保音樂只在初始化後啟動
            }
            playClickSound();
            
            startQuizContainer.classList.add('hidden');
            quizSection.classList.remove('hidden');
            generateNewQuestion();
        });

        newQuestionBtn.addEventListener('click', () => {
            playClickSound();
            generateNewQuestion();
        });

        checkAnswerBtn.addEventListener('click', checkAnswer);
        quizAnswerEl.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') checkAnswer();
        });

        // --- 口訣表產生程式碼 ---
        for (let i = 1; i <= 9; i++) {
            for (let j = 1; j <= 9; j++) {
                const button = document.createElement('button');
                const colorClass = spaceColors[(i - 1) % spaceColors.length];
                button.className = `btn-speak ${colorClass} text-white font-bold p-2 rounded-xl shadow-lg focus:outline-none focus:ring-2 focus:ring-cyan-400 focus:ring-opacity-75 flex flex-col items-center justify-center aspect-square`;
                const emoji_i = spaceEmojis[i - 1];
                button.innerHTML = `
                    <div class="text-3xl sm:text-4xl" aria-hidden="true">${emoji_i}</div>
                    <div class="text-sm sm:text-base mt-1 font-semibold">${i} × ${j} = ${i * j}</div>
                `;
                button.setAttribute('aria-label', `${i} 乘 ${j} 等於 ${i*j}。口訣是：${mnemonics[Math.min(i,j)][Math.max(i,j)]}`);
                button.addEventListener('click', () => {
                    playClickSound();
                    const num1 = Math.min(i, j);
                    const num2 = Math.max(i, j);
                    const mnemonic = mnemonics[num1][num2];
                    speak(mnemonic);
                });
                tableContainer.appendChild(button);
            }
        }
    </script>
</body>
</html>

